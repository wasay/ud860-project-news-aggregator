var APP=APP||{};APP.Data=function(){var e="https://hacker-news.firebaseio.com",t=e+"/v0/topstories.json",n=e+"/v0/item/[ID].json";function r(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="json",n.onload=t,n.send()}return{getTopStories:function(e){r(t,function(t){e(t.target.response)})},getStoryById:function(e,t){r(n.replace(/\[ID\]/,e),function(e){t(e.target.response)})},getStoryComment:function(e,t){r(n.replace(/\[ID\]/,e),function(e){t(e.target.response)})}}}(),APP.Main=function(){var e=document.querySelector.bind(document),t=null,n=0,r=100,i=e("main"),o=!1,s=0,a={data:{intl:{locales:"en-US"}}},l=e("#tmpl-story").textContent,c=e("#tmpl-story-details").textContent,d=e("#tmpl-story-details-comment").textContent;if("undefined"!=typeof HandlebarsIntl)HandlebarsIntl.registerWith(Handlebars);else{var u=/, {{ formatRelative time }}/;l=l.replace(u,""),c=c.replace(u,""),d=d.replace(u,"")}var m=Handlebars.compile(l),y=Handlebars.compile(c),f=Handlebars.compile(d);function p(e,t){for(var n=document.querySelectorAll(".story"),r=0;r<n.length;r++)if(n[r].getAttribute("id")==="s-"+e){t.time*=1e3;var i=n[r],o=m(t);i.innerHTML=o,i.addEventListener("click",v.bind(this,t)),i.classList.add("clickable"),s--}0===s&&g()}function v(t){var n=e("sd-"+t.id);if(requestAnimationFrame(function(t){if(o)return;o=!0;var n=e("#sd-"+t),r=null;if(!n)return;document.body.classList.add("details-active"),n.style.opacity=1,requestAnimationFrame(function e(){var t=n.getBoundingClientRect();null===r&&(r=t.left);r+=.1*(0-t.left);Math.abs(r)>.5?requestAnimationFrame(e):r=0;n.style.left=r+"px"})}.bind(this,t.id)),!n){var r,s,l,c;t.url&&(t.urlobj=new URL(t.url));var d=y(t),u=t.kids,m=f({by:"",text:"Loading comment..."});(n=document.createElement("section")).setAttribute("id","sd-"+t.id),n.classList.add("story-details"),n.innerHTML=d,document.body.appendChild(n),s=n.querySelector(".js-comments"),l=n.querySelector(".js-header"),c=n.querySelector(".js-content"),n.querySelector(".js-close").addEventListener("click",function(t){if(!o)return;var n=e("#sd-"+t),r=0;document.body.classList.remove("details-active"),n.style.opacity=0,requestAnimationFrame(function e(){var t=i.getBoundingClientRect();var s=n.getBoundingClientRect();var a=t.width+100;r+=.1*(a-s.left);Math.abs(r-a)>.5?requestAnimationFrame(e):(r=a,o=!1);n.style.left=r+"px"})}.bind(this,t.id));var p=l.getBoundingClientRect().height;if(c.style.paddingTop=p+"px",void 0===u)return;for(var v=0;v<u.length;v++)(r=document.createElement("aside")).setAttribute("id","sdc-"+u[v]),r.classList.add("story-details__comment"),r.innerHTML=m,s.appendChild(r),APP.Data.getStoryComment(u[v],function(e){void 0!==e&&(e.time*=1e3,s.querySelector("#sdc-"+e.id).innerHTML=f(e,a))})}}function g(){for(var e=document.querySelectorAll(".story"),t=i.offsetHeight,n=(i.getBoundingClientRect(),document.body.getBoundingClientRect().top),r=[],o=0;o<e.length;o++){var s=e[o].querySelector(".story__score"),a=s.getBoundingClientRect().top-n,l=Math.min(1,1-(a-170)/t*.05),c=Math.min(1,1-(a-170)/t*.5),d=((a=s.getBoundingClientRect()).width-38)/2*100;r.push([l,d,c])}for(var u=0;u<r.length;u++){var m=e[u],y=m.querySelector(".story__score"),f=m.querySelector(".story__title"),p=r[u][0],v=r[u][1],g=r[u][2];y.style.width=40*p+"px",y.style.height=40*p+"px",y.style.lineHeight=40*p+"px",y.style.backgroundColor="hsl(42, "+v+"%, 22%)",f.style.opacity=g.toString()}}function h(){if(!(s>0)){s=r;for(var e=n+r,o=n;o<e;o++){if(o>=t.length)return;var a=String(t[o]),l=document.createElement("div");l.setAttribute("id","s-"+a),l.classList.add("story"),l.innerHTML=m({title:"...",score:"-",by:"...",time:0}),i.appendChild(l),APP.Data.getStoryById(t[o],p.bind(this,a))}n+=r}}i.addEventListener("touchstart",function(e){Math.random()>.97&&e.preventDefault()},{passive:!0}),i.addEventListener("scroll",function(){var t=e("header"),n=t.querySelector(".header__title-wrapper"),r=Math.min(70,i.scrollTop),o="scale("+(1-r/300)+")";g(),t.style.height=156-r+"px",n.style.webkitTransform=o,n.style.transform=o,i.scrollTop>70?document.body.classList.add("raised"):document.body.classList.remove("raised");var s=i.scrollHeight-i.offsetHeight-300;i.scrollTop>s&&h()},{passive:!0}),APP.Data.getTopStories(function(e){t=e,h(),i.classList.remove("loading")})}(),navigator.serviceWorker&&navigator.serviceWorker.register("sw.js").then(function(){}).catch(function(){});