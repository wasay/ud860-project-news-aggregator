var APP=APP||{};APP.Data=function(){var e="https://hacker-news.firebaseio.com",t=e+"/v0/topstories.json",n=e+"/v0/item/[ID].json";function i(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="json",n.onload=t,n.send()}return{getTopStories:function(e){i(t,function(t){e(t.target.response)})},getStoryById:function(e,t){i(n.replace(/\[ID\]/,e),function(e){t(e.target.response)})},getStoryComment:function(e,t){i(n.replace(/\[ID\]/,e),function(e){t(e.target.response)})}}}(),APP.Main=function(){var e=document.querySelector.bind(document),t=null,n=0,i=100,r=e("main"),o=!1,s=0,a={data:{intl:{locales:"en-US"}}},l=e("#tmpl-story").textContent,c=e("#tmpl-story-details").textContent,d=e("#tmpl-story-details-comment").textContent;if("undefined"!=typeof HandlebarsIntl)HandlebarsIntl.registerWith(Handlebars);else{var u=/, {{ formatRelative time }}/;l=l.replace(u,""),c=c.replace(u,""),d=d.replace(u,"")}var m=Handlebars.compile(l),y=Handlebars.compile(c),f=Handlebars.compile(d);function p(e,t){for(var n=document.querySelectorAll(".story"),i=0;i<n.length;i++)if(n[i].getAttribute("id")==="s-"+e){t.time*=1e3;var r=n[i],o=m(t);r.innerHTML=o,r.addEventListener("click",v.bind(this,t)),r.classList.add("clickable"),s--}0===s&&g()}function v(t){var n=e("sd-"+t.id);if(requestAnimationFrame(function(t){if(o)return;o=!0;var n=e("#sd-"+t),i=null;if(!n)return;document.body.classList.add("details-active"),n.style.opacity=1,requestAnimationFrame(function e(){var t=n.getBoundingClientRect();null===i&&(i=t.left);i+=.1*(0-t.left);Math.abs(i)>.5?requestAnimationFrame(e):i=0;n.style.left=i+"px"})}.bind(this,t.id)),!n){var i,s,l,c;t.url&&(t.urlobj=new URL(t.url));var d=y(t),u=t.kids,m=f({by:"",text:"Loading comment..."});(n=document.createElement("section")).setAttribute("id","sd-"+t.id),n.classList.add("story-details"),n.innerHTML=d,document.body.appendChild(n),s=n.querySelector(".js-comments"),l=n.querySelector(".js-header"),c=n.querySelector(".js-content"),n.querySelector(".js-close").addEventListener("click",function(t){if(!o)return;var n=e("#sd-"+t),i=0;document.body.classList.remove("details-active"),n.style.opacity=0,requestAnimationFrame(function e(){var t=r.getBoundingClientRect();var s=n.getBoundingClientRect();var a=t.width+100;i+=.1*(a-s.left);Math.abs(i-a)>.5?requestAnimationFrame(e):(i=a,o=!1);n.style.left=i+"px"})}.bind(this,t.id));var p=l.getBoundingClientRect().height;if(c.style.paddingTop=p+"px",void 0===u)return;for(var v=0;v<u.length;v++)(i=document.createElement("aside")).setAttribute("id","sdc-"+u[v]),i.classList.add("story-details__comment"),i.innerHTML=m,s.appendChild(i),APP.Data.getStoryComment(u[v],function(e){e.time*=1e3,s.querySelector("#sdc-"+e.id).innerHTML=f(e,a)})}}function g(){for(var e=document.querySelectorAll(".story"),t=r.offsetHeight,n=(r.getBoundingClientRect(),document.body.getBoundingClientRect().top),i=0;i<e.length;i++){var o=e[i],s=o.querySelector(".story__score"),a=o.querySelector(".story__title"),l=s.getBoundingClientRect().top-n,c=Math.min(1,1-(l-170)/t*.05),d=Math.min(1,1-(l-170)/t*.5);s.style.width=40*c+"px",s.style.height=40*c+"px",s.style.lineHeight=40*c+"px";var u=((l=s.getBoundingClientRect()).width-38)/2*100;s.style.backgroundColor="hsl(42, "+u+"%, 50%)",a.style.opacity=d}}function h(){if(!(s>0)){s=i;for(var e=n+i,o=n;o<e;o++){if(o>=t.length)return;var a=String(t[o]),l=document.createElement("div");l.setAttribute("id","s-"+a),l.classList.add("story"),l.innerHTML=m({title:"...",score:"-",by:"...",time:0}),r.appendChild(l),APP.Data.getStoryById(t[o],p.bind(this,a))}n+=i}}r.addEventListener("touchstart",function(e){Math.random()>.97&&e.preventDefault()},{passive:!0}),r.addEventListener("scroll",function(){var t=e("header"),n=t.querySelector(".header__title-wrapper"),i=Math.min(70,r.scrollTop),o="scale("+(1-i/300)+")";g(),t.style.height=156-i+"px",n.style.webkitTransform=o,n.style.transform=o,r.scrollTop>70?document.body.classList.add("raised"):document.body.classList.remove("raised");var s=r.scrollHeight-r.offsetHeight-300;r.scrollTop>s&&h()},{passive:!0}),APP.Data.getTopStories(function(e){t=e,h(),r.classList.remove("loading")})}(),navigator.serviceWorker&&navigator.serviceWorker.register("sw.js").then(function(){}).catch(function(){});